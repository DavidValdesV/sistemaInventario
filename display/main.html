<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario MUNI Quilleco</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Manrope:wght@400;500;700;800&family=Noto+Sans:wght@400;500;700;900"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body style='font-family: Manrope, "Noto Sans", sans-serif;'>
    <div class="relative flex min-h-screen flex-col bg-white overflow-x-hidden">
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between border-b border-[#f1f4f1] px-10 py-3">
          <div class="flex items-center gap-8">
            <div class="flex items-center gap-4 text-[#131712]">
              <div class="size-6 text-[#0c7ff2]">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                </svg>
              </div>
              <h2 class="text-lg font-bold tracking-[-0.015em]">Sistema de Inventario</h2>
            </div>
            <nav class="flex items-center gap-9">
              <a class="text-sm font-medium" href="/main.html">Dashboard</a>
              <a class="text-sm font-medium" href="/articulos.html">Articulos</a>
              <a class="text-sm font-medium" href="/proveedores.html">Proveedores</a>
              <a class="text-sm font-medium" href="#">Usuarios</a>
              <a class="text-sm font-medium" href="/solicitudes.html">Solicitudes</a>
              <a class="text-sm font-medium" href="#">Recepciones</a>
            </nav>
          </div>
          <div class="flex items-center gap-8">
            <label class="flex w-64 h-10">
              <div class="flex items-center justify-center pl-4 bg-[#f1f4f1] rounded-l-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z" />
                </svg>
              </div>
              <input
                placeholder="Search"
                class="w-full flex-1 px-4 bg-[#f1f4f1] rounded-r-lg text-sm focus:outline-none"
              />
            </label>
            <div
              class="size-10 rounded-full bg-cover bg-center"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCMKo0ZWi5MrH51R1yrD2BmMBevFdzqEttaC0k8Y3WhGtLRc-AG70EzCCvvPEeF0g8CxDPlqqRne1Z2nKyzNXm6R4qpYQa1KGFOC95x4ZHciXa33RXT100FIKLiI2_K8hnAQq4QpeAesN-Oa6I_vXt3n4qdecI8wbm2YjxpxqvztfEbsYIJ5xaNjpo98yFrbVE30wR4hNEPXlrc5C93ooIW1_noV4sjw433fiz9Dxnuc9I3dN9_PZuIPdi_9mmTDaGu2XB3o6wsHws");'
            ></div>
          </div>
        </header>

        <main class="px-40 py-5 flex-1">
          <div class="max-w-[960px] mx-auto">
            <div class="p-4">
              <p class="text-[32px] font-bold">Dashboard</p>
            </div>
            <div class="flex flex-wrap gap-4 p-4">
              <div class="flex-1 min-w-[158px] p-6 rounded-lg bg-[#f1f4f1]">
                <p class="text-base font-medium">Artículos Totales</p>
                <p id="totalItems" class="text-2xl font-bold">0</p>
              </div>
              <div class="flex-1 min-w-[158px] p-6 rounded-lg bg-[#f1f4f1]">
                <p class="text-base font-medium">Cantidad de Stock</p>
                <p id="stockLevel" class="text-2xl font-bold">0</p>
              </div>
              <div class="flex-1 min-w-[158px] p-6 rounded-lg bg-[#f1f4f1]">
                <p class="text-base font-medium">Solicitudes Pendientes</p>
                <p id="pendingRequests" class="text-2xl font-bold">0</p>
              </div>
            </div>

            <h2 class="text-[22px] font-bold px-4 pt-5 pb-3">Actividad Reciente</h2>
            <div class="px-4 py-3 rounded-lg border border-[#dee4dc] bg-white">
              <div id="movimientosRecientesContainer">
                <p class="text-sm text-gray-500" id="noMovimientosMessage">Sin movimientos recientes aún.</p>
              </div>
            </div>

            <h2 class="text-[22px] font-bold px-4 pt-5 pb-3">Solicitudes Pendientes</h2>
            <div class="px-4 py-3 rounded-lg border border-[#dee4dc] bg-white">
              <p class="text-sm text-gray-500">Sin solicitudes pendientes aún.</p>
            </div>
          </div>
        </main>
      </div>
    </div>

    <template id="movimientoTemplate">
      <div class="flex items-center gap-2 p-2 border-b border-[#dee4dc] last:border-b-0">
        <div class="size-8 rounded-full flex items-center justify-center text-white text-xs font-semibold" data-type-color>
          </div>
        <div>
          <p class="text-sm font-semibold" data-movimiento-title>Título del movimiento</p>
          <p class="text-xs text-gray-600" data-movimiento-details>Detalles</p>
          <p class="text-xs text-gray-600" data-movimiento-fecha>Fecha y hora</p>
        </div>
        <span class="ml-auto text-sm font-bold" data-movimiento-cantidad>+0</span>
      </div>
    </template>

    <script>
      async function cargarEstadisticas() {
        try {
          const [itemsRes, stockRes, reqRes] = await Promise.all([
            fetch('/api/stats/total-items'),
            fetch('/api/stats/stock-level'),
            fetch('/api/stats/pending-requests')
          ]);

          const items = await itemsRes.json();
          const stock = await stockRes.json();
          const requests = await reqRes.json();

          document.getElementById('totalItems').innerText = items.total ?? 0;
          document.getElementById('stockLevel').innerText = stock.total ?? 0;
          document.getElementById('pendingRequests').innerText = requests.total ?? 0;
        } catch (err) {
          console.error('Error cargando estadísticas:', err);
        }
      }

      async function cargarMovimientosRecientes() {
        try {
          const response = await fetch('/api/movimientos');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const movimientos = await response.json();
          
          const container = document.getElementById('movimientosRecientesContainer');
          const noMovimientosMessage = document.getElementById('noMovimientosMessage');
          const template = document.getElementById('movimientoTemplate');

          // Limpiar mensajes anteriores y contenedores
          container.innerHTML = ''; 

          if (movimientos.length === 0) {
            // Asegurarse de que el mensaje de "No movimientos" esté presente
            if (noMovimientosMessage) {
                container.appendChild(noMovimientosMessage); 
            } else {
                // Si el mensaje fue removido y ahora no hay movimientos, recrearlo
                const p = document.createElement('p');
                p.id = 'noMovimientosMessage';
                p.classList.add('text-sm', 'text-gray-500');
                p.textContent = 'Sin movimientos recientes aún.';
                container.appendChild(p);
            }
          } else {
            // Si hay movimientos, asegurarse de que el mensaje de "No movimientos" no esté
            if (noMovimientosMessage) {
                noMovimientosMessage.remove(); 
            }

            movimientos.forEach(movimiento => {
              const clone = document.importNode(template.content, true);
              const typeDiv = clone.querySelector('[data-type-color]');
              const titleP = clone.querySelector('[data-movimiento-title]');
              const detailsP = clone.querySelector('[data-movimiento-details]');
              const fechaP = clone.querySelector('[data-movimiento-fecha]');
              const cantidadSpan = clone.querySelector('[data-movimiento-cantidad]');

              const nombreArticulo = movimiento.nombre_articulo; // Podría ser 'Artículo Eliminado'
              const categoria = movimiento.nombre_categoria;
              const proveedor = movimiento.nombre_proveedor;
              const marca = movimiento.nombre_marca;
              const usuarioAccion = movimiento.nombre_usuario || 'Desconocido';

              // Construye el título del movimiento
              titleP.textContent = `${nombreArticulo} - ${movimiento.tipo_movimiento.charAt(0).toUpperCase() + movimiento.tipo_movimiento.slice(1)}`;
              
              // Construye los detalles del movimiento
              detailsP.textContent = `${categoria} - ${marca} - ${proveedor} (por ${usuarioAccion})`;
              
              // Formatear la fecha
              fechaP.textContent = new Date(movimiento.fecha).toLocaleString();

              let cantidadTexto = '';
              let colorClass = '';
              let initials = '';

              switch (movimiento.tipo_movimiento) {
                case 'entrada':
                  cantidadTexto = `+${movimiento.cantidad}`;
                  colorClass = 'bg-green-500';
                  initials = 'E';
                  break;
                case 'salida':
                  cantidadTexto = `-${movimiento.cantidad}`;
                  colorClass = 'bg-red-500';
                  initials = 'S';
                  break;
                case 'eliminacion':
                  cantidadTexto = `-${movimiento.cantidad}`;
                  colorClass = 'bg-gray-500';
                  initials = 'X'; 
                  break;
                case 'edicion':
                  // Si la cantidad de movimiento es 0 (solo edición de metadatos)
                  if (movimiento.cantidad === 0) {
                      cantidadTexto = 'Ajuste';
                      colorClass = 'bg-blue-500';
                      initials = 'A'; 
                  } else { // Si la edición también implica un cambio de cantidad
                      cantidadTexto = movimiento.cantidad > 0 ? `+${movimiento.cantidad}` : `${movimiento.cantidad}`;
                      colorClass = movimiento.cantidad > 0 ? 'bg-green-500' : 'bg-red-500';
                      initials = 'A';
                  }
                  break;
                default:
                  cantidadTexto = `±${movimiento.cantidad}`;
                  colorClass = 'bg-purple-500';
                  initials = '?';
              }
              
              cantidadSpan.textContent = cantidadTexto;
              typeDiv.classList.add(colorClass);
              typeDiv.textContent = initials;

              container.appendChild(clone);
            });
          }
        } catch (err) {
          console.error('Error cargando movimientos recientes:', err);
          document.getElementById('movimientosRecientesContainer').innerHTML = 
            '<p class="text-sm text-red-500">Error al cargar movimientos.</p>';
        }
      }

      // Llama a ambas funciones cuando la página se carga
      window.onload = async () => {
          await cargarEstadisticas();
          await cargarMovimientosRecientes(); 
      };
    </script>
  </body>
</html>